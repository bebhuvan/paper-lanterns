---
import Layout from '../../layouts/Layout.astro';
import Navigation from '../../components/Navigation.astro';
import StructuredData from '../../components/StructuredData.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ArticleHeader from '../../components/ArticleHeader.astro';
import ShareActions from '../../components/ShareActions.astro';
import TagList from '../../components/TagList.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import { getSpeeches, getAllContentItems, getAdjacentItems } from '../../lib/data-layer';
import { calculateReadingTime, getRelatedContent } from '../../lib/content';

export async function getStaticPaths() {
  const speeches = await getSpeeches();
  return speeches.map((speech) => ({
    params: { slug: speech.slug },
    props: speech,
  }));
}

const speech = Astro.props;
const { Content } = await speech.render();

// Calculate reading time using utility
const readTime = calculateReadingTime(speech.body);

// Get all content and speeches for navigation and related items
const allSpeeches = await getSpeeches();
const allContent = await getAllContentItems();

// Get adjacent speeches for navigation
const { prev: prevSpeech, next: nextSpeech } = getAdjacentItems(
  allSpeeches,
  speech.slug,
  item => item.slug
);

// Get related content using utility function
const speechWithType = { ...speech, contentType: 'speech' as const };
const related = getRelatedContent(speechWithType, allContent, 4);

// Get current index for navigation display
const currentIndex = allSpeeches.findIndex(s => s.slug === speech.slug);
---

<Layout 
  title={`${speech.data.title} by ${speech.data.author.name} - Paper Lanterns`}
  description={`A ${speech.data.date.getFullYear()} speech by ${speech.data.author.name}${speech.data.context ? ` ${speech.data.context.replace(/\[([^\]]*)\]\([^)]*\)/g, '$1')}` : ''}. ${speech.data.excerpt}`}
  author={speech.data.author.name}
  publishedTime={speech.data.date.toISOString()}
>
    <StructuredData
    type="Article"
    title={speech.data.title}
    description={speech.data.excerpt}
    author={speech.data.author.name}
    publishedTime={speech.data.date.toISOString()}
    url={Astro.url.href}
    image={speech.data.image || '/og-speech.png'}
    keywords={speech.data.tags}
  />
  <Navigation />
  
  <Breadcrumb items={[
    { label: 'Speeches', url: '/speechs' },
    { label: speech.data.title }
  ]} />

  <main class="reading-container">
    <a href="/" class="back-link">← Back to Paper Lanterns</a>

    <article class="speech">
      <ArticleHeader
        title={speech.data.title}
        author={speech.data.author}
        date={speech.data.date}
        location={speech.data.location}
        readTime={readTime}
        category="Speech"
      />
      
      <div class="speech-content" style={`--drop-cap-color: ${speech.data.drop_cap_color}`}>
        <Content />
      </div>

      {speech.data.video && speech.data.video.youtube_id && (
        <div class="video-section">
          <h3 class="video-title">Watch the Historic Speech</h3>
          <div class="video-container">
            <iframe
              src={`https://www.youtube-nocookie.com/embed/${speech.data.video.youtube_id}?rel=0&modestbranding=1`}
              title={speech.data.video.title || "Speech Video"}
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            ></iframe>
          </div>
          {speech.data.video.description && (
            <p class="video-description">{speech.data.video.description}</p>
          )}
        </div>
      )}

      {speech.data.about && (speech.data.about.context || speech.data.about.significance || speech.data.about.author_bio || speech.data.about.occasion_info || (speech.data.about.links && speech.data.about.links.length > 0)) && (
        <section class="about-section">
          <h2 class="about-title">About This Speech</h2>
          
          {speech.data.about.context && (
            <div class="about-item">
              <h3>Historical Context</h3>
              <div class="about-content">
                <p>{speech.data.about.context}</p>
              </div>
            </div>
          )}
          
          {speech.data.about.significance && (
            <div class="about-item">
              <h3>Significance</h3>
              <div class="about-content">
                <p>{speech.data.about.significance}</p>
              </div>
            </div>
          )}
          
          {speech.data.about.author_bio && (
            <div class="about-item">
              <h3>About {speech.data.author.name}</h3>
              <div class="about-content">
                <p>{speech.data.about.author_bio}</p>
              </div>
            </div>
          )}
          
          {speech.data.about.occasion_info && (
            <div class="about-item">
              <h3>About the Occasion</h3>
              <div class="about-content">
                <p>{speech.data.about.occasion_info}</p>
              </div>
            </div>
          )}
          
          {speech.data.about.links && speech.data.about.links.length > 0 && (
            <div class="about-item">
              <h3>Additional Resources</h3>
              <ul class="resource-links">
                {speech.data.about.links.map(link => (
                  <li>
                    <a href={link.url} target="_blank" rel="noopener noreferrer" class="resource-link">
                      {link.title}
                      <svg class="external-link-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M7 7h10v10M7 17L17 7"></path>
                      </svg>
                    </a>
                    {link.description && <span class="resource-description">{link.description}</span>}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </section>
      )}

      <TagList tags={speech.data.tags} />

      <ShareActions />
    </article>

    <RelatedContent items={related} title="Related Content" />

    <nav class="speech-nav">
      {prevSpeech ? (
        <a href={`/speech/${prevSpeech.slug}`} class="nav-link">← Previous speech</a>
      ) : (
        <span class="nav-link disabled">← Previous speech</span>
      )}
      
      <div class="speech-info">
        Speech {currentIndex + 1} of {allSpeeches.length}
      </div>
      
      {nextSpeech ? (
        <a href={`/speech/${nextSpeech.slug}`} class="nav-link">Next speech →</a>
      ) : (
        <span class="nav-link disabled">Next speech →</span>
      )}
    </nav>

    <footer class="footer">
      <p>Source: {speech.data.source}</p>
      <p>All content is in the public domain</p>
    </footer>
  </main>
</Layout>

<style>
  @import '../../styles/article-content.css';
</style>

<script>
  // Share functionality
  async function shareContent() {
    if (navigator.share) {
      try {
        await navigator.share({
          title: document.title,
          url: window.location.href
        });
      } catch (err) {
        copyLink();
      }
    } else {
      copyLink();
    }
  }

  // Copy link to clipboard
  async function copyLink() {
    try {
      await navigator.clipboard.writeText(window.location.href);
      showToast('Link copied to clipboard');
    } catch (err) {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = window.location.href;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      showToast('Link copied to clipboard');
    }
  }

  // Copy text content
  async function copyText() {
    const speechContent = document.querySelector('.speech-content');
    if (speechContent) {
      const text = speechContent.textContent || speechContent.innerText;
      try {
        await navigator.clipboard.writeText(text);
        showToast('Speech text copied to clipboard');
      } catch (err) {
        console.error('Failed to copy text:', err);
      }
    }
  }

  // Simple toast notification
  function showToast(message: string) {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-size: 0.9rem;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.style.opacity = '1', 100);
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => document.body.removeChild(toast), 300);
    }, 2000);
  }

  // Make functions globally available
  (window as any).shareContent = shareContent;
  (window as any).copyLink = copyLink;
  (window as any).copyText = copyText;
</script>