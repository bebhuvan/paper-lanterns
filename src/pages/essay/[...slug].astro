---
import { getCollection, getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Navigation from '../../components/Navigation.astro';

export async function getStaticPaths() {
  const essays = await getCollection('essays');
  return essays.map(essay => ({
    params: { slug: essay.slug },
    props: { essay }
  }));
}

const { essay } = Astro.props;
const { Content } = await essay.render();

// Format date
const formattedDate = essay.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Get other essays for navigation
const allEssays = await getCollection('essays');
const sortedEssays = allEssays.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const currentIndex = sortedEssays.findIndex(e => e.slug === essay.slug);
const prevEssay = currentIndex < sortedEssays.length - 1 ? sortedEssays[currentIndex + 1] : null;
const nextEssay = currentIndex > 0 ? sortedEssays[currentIndex - 1] : null;
---

<Layout 
  title={`${essay.data.title} by ${essay.data.author.name} - Paper Lanterns`}
  description={`A ${essay.data.date.getFullYear()} essay by ${essay.data.author.name}. ${essay.data.context.replace(/\[([^\]]*)\]\([^)]*\)/g, '$1')}${essay.data.excerpt ? ` ${essay.data.excerpt}` : ''}`}
  author={essay.data.author.name}
  publishedTime={essay.data.date.toISOString()}
>
  <Navigation />
  
  <main>
    <article class="essay">
      <div class="reading-container">
        <a href="/essays" class="back-link">← Back to Essays</a>
        
        <header class="essay-header">
          <div class="essay-meta">
            <time class="date">{formattedDate}</time>
            <span class="author">{essay.data.author.name}</span>
          </div>
          
          <h1 class="essay-title">{essay.data.title}</h1>
          
          <p class="context">{essay.data.context.replace(/\[([^\]]*)\]\([^)]*\)/g, '$1')}</p>
          
          {essay.data.source && (
            <div class="source">
              <strong>Source:</strong> {essay.data.source}
            </div>
          )}
          
          <div class="tags">
            {essay.data.tags.map(tag => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        </header>
        
        <div class="essay-content">
          <Content />
        </div>

        {essay.data.about && (essay.data.about.context || essay.data.about.significance || essay.data.about.author_bio || (essay.data.about.links && essay.data.about.links.length > 0)) && (
          <section class="about-section">
            <h2 class="about-title">About This Essay</h2>
            
            {essay.data.about.context && (
              <div class="about-item">
                <h3>Historical Context</h3>
                <div class="about-content">
                  <p>{essay.data.about.context}</p>
                </div>
              </div>
            )}
            
            {essay.data.about.significance && (
              <div class="about-item">
                <h3>Significance</h3>
                <div class="about-content">
                  <p>{essay.data.about.significance}</p>
                </div>
              </div>
            )}
            
            {essay.data.about.author_bio && (
              <div class="about-item">
                <h3>About {essay.data.author.name}</h3>
                <div class="about-content">
                  <p>{essay.data.about.author_bio}</p>
                </div>
              </div>
            )}
            
            {essay.data.about.links && essay.data.about.links.length > 0 && (
              <div class="about-item">
                <h3>Additional Resources</h3>
                <ul class="resource-links">
                  {essay.data.about.links.map(link => (
                    <li>
                      <a href={link.url} target="_blank" rel="noopener noreferrer" class="resource-link">
                        {link.title}
                        <svg class="external-link-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M7 7h10v10M7 17L17 7"></path>
                        </svg>
                      </a>
                      {link.description && <span class="resource-description">{link.description}</span>}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </section>
        )}
        
        <footer class="essay-footer">
          <div class="essay-nav">
            {prevEssay && (
              <a href={`/essay/${prevEssay.slug}`} class="nav-prev">
                <span class="nav-label">← Previous Essay</span>
                <span class="nav-title">{prevEssay.data.title}</span>
              </a>
            )}
            {nextEssay && (
              <a href={`/essay/${nextEssay.slug}`} class="nav-next">
                <span class="nav-label">Next Essay →</span>
                <span class="nav-title">{nextEssay.data.title}</span>
              </a>
            )}
          </div>
          
          <div class="footer-actions">
            <a href="/essays" class="secondary-button">Browse All Essays</a>
            <button class="secondary-button" onclick="window.print()">Print Essay</button>
          </div>
        </footer>
      </div>
    </article>
  </main>
</Layout>

<style>
  .essay {
    min-height: 100vh;
    padding: 2rem 0 4rem;
  }

  .reading-container {
    max-width: 45rem;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 3rem;
    transition: color 0.2s ease;
  }

  .back-link:hover {
    color: var(--accent-primary);
  }

  .essay-header {
    margin-bottom: 3rem;
  }

  .essay-meta {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    font-size: 0.95rem;
    color: var(--text-muted);
    margin-bottom: 1.5rem;
  }

  .date {
    color: var(--accent-secondary);
  }

  .author {
    font-weight: 500;
    color: var(--text-secondary);
  }

  .essay-title {
    font-family: 'EB Garamond', serif;
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 500;
    line-height: 1.2;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    letter-spacing: -0.02em;
  }

  .context {
    font-size: 1.1rem;
    line-height: 1.6;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
  }

  .source {
    font-size: 0.95rem;
    color: var(--text-muted);
    padding: 1rem;
    background: var(--bg-accent);
    border-left: 3px solid var(--accent-primary);
    border-radius: 4px;
    margin-bottom: 1.5rem;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  .tag {
    background: var(--bg-accent);
    color: var(--text-secondary);
    padding: 0.35rem 0.85rem;
    border-radius: 20px;
    font-size: 0.85rem;
    border: 1px solid var(--border-accent);
  }

  .essay-content {
    font-family: 'Crimson Text', serif;
    font-size: 1.125rem;
    line-height: 1.8;
    color: var(--text-primary);
    overflow-wrap: break-word;
    word-wrap: break-word;
  }

  /* Content typography */
  .essay-content :global(p) {
    margin-bottom: 1.5rem;
    text-align: justify;
    hyphens: auto;
  }

  .essay-content :global(p:first-of-type) {
    font-size: 1.2rem;
    line-height: 1.7;
  }

  .essay-content :global(p:first-of-type::first-letter) {
    font-family: 'EB Garamond', serif;
    font-size: 4rem;
    font-weight: 500;
    line-height: 1;
    float: left;
    margin: 0.1rem 0.5rem 0 0;
    color: var(--accent-primary);
  }

  .essay-content :global(h2),
  .essay-content :global(h3),
  .essay-content :global(h4) {
    font-family: 'EB Garamond', serif;
    font-weight: 500;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .essay-content :global(h2) {
    font-size: 1.8rem;
  }

  .essay-content :global(h3) {
    font-size: 1.4rem;
  }

  .essay-content :global(blockquote) {
    border-left: 3px solid var(--accent-primary);
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: var(--text-secondary);
  }

  .essay-content :global(ul),
  .essay-content :global(ol) {
    margin: 1.5rem 0;
    padding-left: 2rem;
  }

  .essay-content :global(li) {
    margin-bottom: 0.5rem;
    line-height: 1.7;
  }

  .essay-content :global(strong) {
    font-weight: 600;
    color: var(--text-primary);
  }

  .essay-content :global(em) {
    font-style: italic;
  }

  .essay-content :global(a) {
    color: var(--accent-primary);
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
    transition: all 0.2s ease;
  }

  .essay-content :global(a:hover) {
    color: var(--accent-tertiary);
    text-decoration-thickness: 2px;
  }

  /* Fix for long words and URLs */
  .essay-content :global(code) {
    font-family: monospace;
    font-size: 0.9em;
    background: var(--bg-accent);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    word-break: break-all;
  }

  .essay-content :global(pre) {
    background: var(--bg-accent);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .essay-content :global(pre code) {
    background: none;
    padding: 0;
    font-size: 0.9rem;
  }

  .about-section {
    background: var(--bg-accent);
    border: 1px solid var(--border-accent);
    border-radius: 12px;
    padding: 3rem;
    margin: 3rem 0 0 0;
    position: relative;
  }

  .about-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-tertiary) 50%, var(--accent-primary) 100%);
    border-radius: 12px 12px 0 0;
    opacity: 0.6;
  }

  .about-title {
    font-family: 'EB Garamond', serif;
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 2rem;
    text-align: center;
    position: relative;
  }

  .about-title::after {
    content: '✦';
    position: absolute;
    bottom: -1rem;
    left: 50%;
    transform: translateX(-50%);
    color: var(--accent-primary);
    font-size: 0.8rem;
    opacity: 0.6;
  }

  .about-item {
    margin-bottom: 2.5rem;
  }

  .about-item:last-child {
    margin-bottom: 0;
  }

  .about-item h3 {
    font-family: 'EB Garamond', serif;
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--accent-secondary);
    margin-bottom: 0.8rem;
    letter-spacing: 0.01em;
  }

  .about-content {
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text-secondary);
  }

  .about-content p {
    margin-bottom: 1rem;
  }

  .about-content p:last-child {
    margin-bottom: 0;
  }

  .about-content a {
    color: var(--accent-secondary);
    text-decoration: none;
    border-bottom: 1px solid rgba(139, 115, 85, 0.3);
    transition: all 0.2s ease;
  }

  .about-content a:hover {
    color: var(--text-primary);
    border-bottom-color: rgba(139, 115, 85, 0.6);
  }

  .resource-links {
    list-style: none;
    padding: 0;
  }

  .resource-links li {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
    position: relative;
  }

  .resource-links li::before {
    content: '→';
    position: absolute;
    left: 0;
    color: var(--accent-primary);
    font-weight: 500;
  }

  .resource-link {
    color: var(--accent-secondary);
    text-decoration: none;
    font-weight: 400;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    transition: color 0.2s ease;
  }

  .resource-link:hover {
    color: var(--text-primary);
  }

  .external-link-icon {
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }

  .resource-link:hover .external-link-icon {
    opacity: 1;
  }

  .resource-description {
    display: block;
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 0.3rem;
    font-style: italic;
  }

  .essay-footer {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-secondary);
  }

  .essay-nav {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .nav-prev,
  .nav-next {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--bg-accent);
    border: 1px solid var(--border-secondary);
    border-radius: 8px;
    transition: all 0.2s ease;
  }

  .nav-prev:hover,
  .nav-next:hover {
    background: var(--bg-primary);
    border-color: var(--accent-primary);
    transform: translateY(-2px);
  }

  .nav-next {
    text-align: right;
  }

  .nav-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .nav-title {
    font-family: 'EB Garamond', serif;
    font-size: 1.1rem;
    color: var(--text-primary);
    font-weight: 500;
  }

  .footer-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .secondary-button {
    padding: 0.75rem 1.5rem;
    background: var(--bg-accent);
    color: var(--text-primary);
    border: 1px solid var(--border-accent);
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .secondary-button:hover {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .reading-container {
      padding: 0 1.5rem; /* More padding for comfortable reading */
      max-width: 100%;
    }

    .essay-header {
      margin-bottom: 2rem;
    }

    .essay-title {
      font-size: clamp(2rem, 7vw, 3rem);
      margin-bottom: 1rem;
    }

    .essay-content {
      font-size: 1.1rem; /* Larger for mobile readability */
      line-height: 1.8;
    }

    .essay-content :global(p) {
      text-align: left;
      hyphens: none;
    }

    .essay-nav {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .footer-actions {
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .secondary-button {
      width: 100%;
      max-width: 300px;
      min-height: 48px; /* Better touch target */
      font-size: 1rem;
    }

    .about-section {
      padding: 2rem 1.5rem;
      margin: 3rem 0;
    }

    .about-title {
      font-size: 1.3rem;
    }

    .about-item h3 {
      font-size: 1rem;
    }

    .about-content {
      font-size: 0.95rem;
    }
  }

  @media (max-width: 480px) {
    .reading-container {
      padding: 0 1.25rem;
    }

    .essay-title {
      font-size: 1.875rem; /* Better size for small screens */
      line-height: 1.3;
    }

    .context {
      font-size: 1rem;
      line-height: 1.6;
    }

    .essay-content {
      font-size: 1.05rem; /* Optimized for small screens */
      line-height: 1.75;
    }

    .essay-content :global(p:first-of-type) {
      font-size: 1.15rem;
    }

    .essay-content :global(p:first-of-type::first-letter) {
      font-size: 3.5rem; /* Slightly larger drop cap */
      margin-right: 0.35rem;
    }

    .tags {
      justify-content: center;
    }

    .tag {
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
    }
  }
</style>